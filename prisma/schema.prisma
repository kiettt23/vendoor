generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  CUSTOMER
  VENDOR
  ADMIN
}

enum VendorStatus {
  PENDING   // Chờ admin duyệt
  APPROVED  // Đã được duyệt, có thể bán hàng
  REJECTED  // Bị từ chối
  SUSPENDED // Bị đình chỉ
}

enum OrderStatus {
  PENDING_PAYMENT  // Chờ thanh toán
  PENDING          // Đã thanh toán, chờ vendor xử lý
  PROCESSING       // Vendor đang chuẩn bị hàng
  SHIPPED          // Đã giao cho đơn vị vận chuyển
  DELIVERED        // Đã giao thành công
  CANCELLED        // Đã hủy
  REFUNDED         // Đã hoàn tiền
}

enum PaymentStatus {
  PENDING   // Chờ thanh toán
  COMPLETED // Đã thanh toán thành công
  FAILED    // Thanh toán thất bại
  REFUNDED  // Đã hoàn tiền
}

enum PaymentMethod {
  VNPAY
  MOMO      // Làm sau
  ZALOPAY   // Làm sau
  COD       // Làm sau
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed by Better Auth
  name      String?
  phone     String?
  avatar    String?

  roles     Role[]   @default([CUSTOMER]) // Array: có thể vừa CUSTOMER vừa VENDOR

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorProfile VendorProfile?  // Nếu user là vendor

  ordersAsCustomer Order[] @relation("CustomerOrders")
  ordersAsVendor   Order[] @relation("VendorOrders")

  products Product[] // Products user tạo (khi là vendor)

  @@index([email])
  @@map("users")
}

// ============================================
// VENDOR
// ============================================

model VendorProfile {
  id          String        @id @default(cuid())
  userId      String        @unique
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  shopName    String        // Tên shop
  slug        String        @unique // URL-friendly: /shop/abc-store
  description String?       @db.Text
  logo        String?       // Cloudinary URL
  banner      String?       // Cloudinary URL

  // Business info (optional cho MVP)
  businessAddress String?
  businessPhone   String?
  businessEmail   String?

  // Commission settings (default 10%)
  commissionRate Float @default(0.1) // 0.1 = 10%

  status      VendorStatus  @default(PENDING)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([status])
  @@map("vendor_profiles")
}

// ============================================
// PRODUCT & CATEGORY
// ============================================

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique // URL-friendly
  description String?   @db.Text
  image       String?   // Cloudinary URL

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  products    Product[]

  @@index([slug])
  @@map("categories")
}

model Product {
  id          String    @id @default(cuid())

  vendorId    String
  vendor      User      @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])

  name        String
  slug        String    @unique // URL-friendly
  description String?   @db.Text

  // Status
  isActive    Boolean   @default(true) // false = soft delete

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  variants    ProductVariant[]
  images      ProductImage[]

  @@index([vendorId])
  @@index([categoryId])
  @@index([slug])
  @@index([isActive])
  @@map("products")
}

model ProductVariant {
  id          String  @id @default(cuid())

  productId   String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Variant info (nullable nếu product không có variant)
  name        String? // VD: "Đỏ - Size M", hoặc null nếu default variant
  sku         String? @unique // Stock Keeping Unit

  // Variant attributes (nullable)
  color       String?
  size        String?

  // Pricing
  price       Float   // Giá bán (VND)
  compareAtPrice Float? // Giá gốc (để hiển thị % giảm giá)

  // Inventory
  stock       Int     @default(0)

  // Default variant (cho products không có variant)
  isDefault   Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  orderItems  OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(cuid())

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String   // Cloudinary URL
  altText   String?
  order     Int      @default(0) // Thứ tự hiển thị (0 = ảnh chính)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([order])
  @@map("product_images")
}

// ============================================
// ORDER & PAYMENT
// ============================================

model Order {
  id          String      @id @default(cuid())

  // Customer
  customerId  String
  customer    User        @relation("CustomerOrders", fields: [customerId], references: [id])

  // Vendor (1 order = 1 vendor)
  vendorId    String
  vendor      User        @relation("VendorOrders", fields: [vendorId], references: [id])

  // Order info
  orderNumber String      @unique // VD: "ORD-20250113-001"
  status      OrderStatus @default(PENDING_PAYMENT)

  // Pricing
  subtotal    Float       // Tổng tiền sản phẩm
  shippingFee Float       @default(0) // Phí ship (tính sau, MVP = 0)
  tax         Float       @default(0) // Thuế (tính sau, MVP = 0)

  // Commission (CORE - phải có từ đầu)
  platformFee     Float  // Phí platform (= subtotal * platformFeeRate)
  vendorEarnings  Float  // Tiền vendor nhận (= subtotal - platformFee)
  platformFeeRate Float  // % commission (lưu lại để audit, VD: 0.1 = 10%)

  total       Float       // Tổng tiền = subtotal + shippingFee + tax

  // Shipping info
  shippingName    String
  shippingPhone   String
  shippingAddress String
  shippingCity    String?
  shippingDistrict String?
  shippingWard    String?

  trackingNumber  String? // Mã vận đơn (khi status = SHIPPED)

  // Notes
  customerNote    String? @db.Text // Ghi chú từ khách hàng
  vendorNote      String? @db.Text // Ghi chú nội bộ vendor

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  items       OrderItem[]
  payment     Payment?    @relation(fields: [paymentId], references: [id])
  paymentId   String?

  @@index([customerId])
  @@index([vendorId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())

  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  // Snapshot data (lưu lại thông tin tại thời điểm đặt hàng)
  productName   String
  variantName   String?
  price         Float  // Giá tại thời điểm mua
  quantity      Int
  subtotal      Float  // = price * quantity

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([variantId])
  @@map("order_items")
}

model Payment {
  id              String        @id @default(cuid())

  // Payment info
  paymentNumber   String        @unique // VD: "PAY-20250113-001"
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)

  // Amount
  amount          Float

  // VNPay specific (nullable cho methods khác)
  vnpayTransactionId String?   @unique
  vnpayBankCode      String?
  vnpayCardType      String?

  // Timestamps
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  orders          Order[]

  @@index([paymentNumber])
  @@index([status])
  @@map("payments")
}

// ============================================
// FUTURE MODELS (Làm sau MVP)
// ============================================

// model Voucher {}      // Discount system
// model Review {}       // Product reviews
// model Notification {} // Push notifications
// model Conversation {} // Chat vendor-customer
// model Payout {}       // Vendor payout management
// model RefundRequest {} // Refund handling